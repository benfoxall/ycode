import*as c from"../../web_modules/yjs.js";import*as b from"../../web_modules/lib0/error.js";import{createMutex as S}from"../../web_modules/lib0/mutex.js";import"../../web_modules/y-protocols/awareness.js";let h;export const _SET_MONACO=s=>{h=s};class P{constructor(s,e,l){this.start=s,this.end=e,this.direction=l}}const x=(s,e,l)=>{const r=s.getSelection();if(r!==null){const o=r.getStartPosition(),t=r.getEndPosition(),i=c.createRelativePositionFromTypeIndex(l,e.getOffsetAt(o)),n=c.createRelativePositionFromTypeIndex(l,e.getOffsetAt(t));return new P(i,n,r.getDirection())}return null},_=(s,e,l,r)=>{const o=c.createAbsolutePositionFromRelativePosition(l.start,r),t=c.createAbsolutePositionFromRelativePosition(l.end,r);if(o!==null&&t!==null&&o.type===e&&t.type===e){const i=s.getModel(),n=i.getPositionAt(o.index),a=i.getPositionAt(t.index);return h.Selection.createWithDirection(n.lineNumber,n.column,a.lineNumber,a.column,l.direction)}return null};export class MonacoBinding{constructor(s,e,l=new Set,r=null){this.doc=s.doc,this.ytext=s,this.monacoModel=e,this.editors=l,this.mux=S(),this._savedSelections=new Map,this._beforeTransaction=()=>{this.mux(()=>{this._savedSelections=new Map,l.forEach(o=>{if(o.getModel()===e){const t=x(o,e,s);t!==null&&this._savedSelections.set(o,t)}})})},this.doc.on("beforeAllTransactions",this._beforeTransaction),this._decorations=new Map,this._rerenderDecorations=()=>{l.forEach(o=>{if(r&&o.getModel()===e){const t=this._decorations.get(o)||[],i=[];r.getStates().forEach((n,a)=>{if(a!==this.doc.clientID&&n.selection!=null&&n.selection.anchor!=null&&n.selection.head!=null){const d=c.createAbsolutePositionFromRelativePosition(n.selection.anchor,this.doc),u=c.createAbsolutePositionFromRelativePosition(n.selection.head,this.doc);if(d!==null&&u!==null&&d.type===s&&u.type===s){let m,f,g,p;d.index<u.index?(m=e.getPositionAt(d.index),f=e.getPositionAt(u.index),g="yRemoteSelectionHead",p=null):(m=e.getPositionAt(u.index),f=e.getPositionAt(d.index),g=null,p="yRemoteSelectionHead"),i.push({range:new h.Range(m.lineNumber,m.column,f.lineNumber,f.column),options:{className:"yRemoteSelection",afterContentClassName:g,beforeContentClassName:p}})}}}),this._decorations.set(o,o.deltaDecorations(t,i))}else this._decorations.delete(o)})},this._ytextObserver=o=>{this.mux(()=>{let t=0;o.delta.forEach(i=>{if(i.retain!==void 0)t+=i.retain;else if(i.insert!==void 0){const n=e.getPositionAt(t),a=new h.Selection(n.lineNumber,n.column,n.lineNumber,n.column);e.pushEditOperations([],[{range:a,text:i.insert}],()=>null),t+=i.insert.length}else if(i.delete!==void 0){const n=e.getPositionAt(t),a=e.getPositionAt(t+i.delete),d=new h.Selection(n.lineNumber,n.column,a.lineNumber,a.column);e.pushEditOperations([],[{range:d,text:""}],()=>null)}else throw b.unexpectedCase()}),e.pushStackElement(),this._savedSelections.forEach((i,n)=>{const a=_(n,s,i,this.doc);a!==null&&n.setSelection(a)})}),this._rerenderDecorations()},s.observe(this._ytextObserver),e.setValue(s.toString()),this._monacoChangeHandler=e.onDidChangeContent(o=>{this.mux(()=>{this.doc.transact(()=>{o.changes.sort((t,i)=>i.rangeOffset-t.rangeOffset).forEach(t=>{s.delete(t.rangeOffset,t.rangeLength),s.insert(t.rangeOffset,t.text)})},this)})}),e.onWillDispose(()=>{this.destroy()}),r&&(l.forEach(o=>{o.onDidChangeCursorSelection(()=>{if(o.getModel()===e){const t=o.getSelection();if(t===null)return;let i=e.getOffsetAt(t.getStartPosition()),n=e.getOffsetAt(t.getEndPosition());if(t.getDirection()===h.SelectionDirection.RTL){const a=i;i=n,n=a}r.setLocalStateField("selection",{anchor:c.createRelativePositionFromTypeIndex(s,i),head:c.createRelativePositionFromTypeIndex(s,n)})}}),r.on("change",this._rerenderDecorations)}),this.awareness=r)}destroy(){this._monacoChangeHandler.dispose(),this.ytext.unobserve(this._ytextObserver),this.doc.off("beforeAllTransactions",this._beforeTransaction),this.awareness!==null&&this.awareness.off("change",this._rerenderDecorations)}}
