import{O as A,f as I,g as u,e as v,t as U,c as M,w as m,a as D,r as f,b as C,d as L}from"./function-d4886006.js";const g=3e4;class O extends A{constructor(t){super();this.doc=t,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=u();this.getLocalState()!==null&&g/2<=e-this.meta.get(t.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const s=[];this.meta.forEach((l,n)=>{n!==t.clientID&&g<=e-l.lastUpdated&&this.states.has(n)&&s.push(n)}),s.length>0&&b(this,s,"timeout")},I(g/10)),t.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.doc.clientID)||null}setLocalState(t){const e=this.doc.clientID,s=this.meta.get(e),l=s===void 0?0:s.clock+1,n=this.states.get(e);t===null?this.states.delete(e):this.states.set(e,t),this.meta.set(e,{clock:l,lastUpdated:u()});const a=[],i=[],r=[],c=[];t===null?c.push(e):n==null?t!=null&&a.push(e):(i.push(e),v(n,t)||r.push(e)),(a.length>0||r.length>0||c.length>0)&&this.emit("change",[{added:a,updated:r,removed:c},"local"]),this.emit("update",[{added:a,updated:i,removed:c},"local"])}setLocalStateField(t,e){const s=this.getLocalState();s!==null&&(s[t]=e,this.setLocalState(s))}getStates(){return this.states}}const b=(t,e,s)=>{const l=[];for(let n=0;n<e.length;n++){const a=e[n];if(t.states.has(a)){if(t.states.delete(a),a===t.doc.clientID){const i=t.meta.get(a);t.meta.set(a,{clock:i.clock+1,lastUpdated:u()})}l.push(a)}}l.length>0&&(t.emit("change",[{added:[],updated:[],removed:l},s]),t.emit("update",[{added:[],updated:[],removed:l},s]))},j=(t,e,s=t.states)=>{const l=e.length,n=M();m(n,l);for(let a=0;a<l;a++){const i=e[a],r=s.get(i)||null,c=t.meta.get(i).clock;m(n,i),m(n,c),D(n,JSON.stringify(r))}return U(n)},x=(t,e,s)=>{const l=L(e),n=u(),a=[],i=[],r=[],c=[],S=f(l);for(let y=0;y<S;y++){const o=f(l);let h=f(l);const d=JSON.parse(C(l)),p=t.meta.get(o),w=t.states.get(o),k=p===void 0?0:p.clock;(k<h||k===h&&d===null&&t.states.has(o))&&(d===null?o===t.doc.clientID&&t.getLocalState()!=null?h++:t.states.delete(o):t.states.set(o,d),t.meta.set(o,{clock:h,lastUpdated:n}),p===void 0&&d!==null?a.push(o):p!==void 0&&d===null?c.push(o):d!==null&&(v(d,w)||r.push(o),i.push(o)))}(a.length>0||r.length>0||c.length>0)&&t.emit("change",[{added:a,updated:r,removed:c},s]),(a.length>0||i.length>0||c.length>0)&&t.emit("update",[{added:a,updated:i,removed:c},s])};export{O as A,x as a,j as e,b as r};
